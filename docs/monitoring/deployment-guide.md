# Деплой админ-панели CRM системы

## Обзор

Эта документация описывает процесс развертывания админ-панели CRM системы, включая автоматизированные скрипты, CI/CD пайплайн и резервное копирование.

## Архитектура развертывания

Система развертывается с использованием Docker Compose и включает следующие сервисы:

- **Traefik** - Обратный прокси и балансировщик нагрузки
- **PostgreSQL** - База данных
- **Backend** - Spring Boot приложение (API)
- **Frontend** - React приложение (админ-панель)
- **Email Service** - Микросервис отправки email
- **Telegram Service** - Микросервис интеграции с Telegram
- **Prometheus** - Сбор метрик
- **Grafana** - Визуализация метрик
- **Loki** - Сбор логов
- **Promtail** - Агент сбора логов

## Скрипты развертывания

### Полный деплой (`deploy.sh`)

Скрипт `/opt/application/deploy.sh` выполняет полный деплой системы:

1. Останавливает все контейнеры
2. Получает последние изменения из репозитория
3. Создает директории для логов
4. Настраивает cron job для бэкапов
5. Пересобирает все образы
6. Запускает все сервисы
7. Проверяет работоспособность сервисов

Использование:
```bash
cd /opt/application
./deploy.sh
```

### Быстрый деплой (`quick-deploy.sh`)

Скрипт `/opt/application/quick-deploy.sh` выполняет быстрый деплой:

1. Получает последние изменения из репозитория
2. Создает директории для логов
3. Пересобирает и перезапускает контейнеры

Использование:
```bash
cd /opt/application
./quick-deploy.sh
```

## CI/CD пайплайн

Пайплайн определен в файле `.github/workflows/ci-cd.yml` и включает следующие этапы:

### Тестирование

1. **Frontend Tests**
   - Проверка типов TypeScript
   - Запуск unit тестов
   - Сборка фронтенда

2. **Backend Tests**
   - Запуск unit тестов
   - Интеграционные тесты с базой данных

### Сборка и публикация образов

Собираются и публикуются Docker образы:
- Backend
- Frontend
- Email Service
- Telegram Service

### Развертывание в продакшен

1. Подключение к серверу по SSH
2. Обновление кода из репозитория
3. Создание директорий для логов
4. Настройка cron job для бэкапов
5. Аутентификация в Container Registry
6. Получение последних Docker образов
7. Запуск всех сервисов
8. Проверка работоспособности

## Резервное копирование

### Скрипты бэкапов

#### Создание бэкапа (`scripts/admin-panel-backup.sh`)

Скрипт создает резервную копию:
- Базы данных (SQL дамп)
- Конфигурационных файлов
- Сжимает бэкап в tar.gz архив
- Удаляет старые бэкапы (по умолчанию старше 7 дней)

Использование:
```bash
cd /opt/application
./scripts/admin-panel-backup.sh
```

#### Восстановление из бэкапа (`scripts/admin-panel-restore.sh`)

Скрипт восстанавливает систему из бэкапа:
- Останавливает сервисы
- Распаковывает бэкап
- Восстанавливает базу данных
- Восстанавливает конфигурационные файлы
- Перезапускает все сервисы

Использование:
```bash
cd /opt/application
./scripts/admin-panel-restore.sh /opt/application/backups/backup_20250919_143022.tar.gz
```

### Автоматические бэкапы

Настроено автоматическое создание бэкапов через cron:
- Ежедневно в 02:00
- Еженедельно (воскресенье) в 01:00

Конфигурация: `/opt/application/scripts/cron/admin-panel-backup-cron`

## Масштабирование

### Горизонтальное масштабирование

Система поддерживает горизонтальное масштабирование следующих сервисов:

1. **Backend** - Может быть масштабирован горизонтально
2. **Frontend** - Может быть масштабирован горизонтально
3. **Email Service** - Может быть масштабирован горизонтально
4. **Telegram Service** - Может быть масштабирован горизонтально

### Балансировка нагрузки

Traefik автоматически балансирует нагрузку между экземплярами сервисов.

Для масштабирования сервиса используйте:
```bash
docker compose up -d --scale backend=3
```

## Откат при ошибках

### Автоматический откат

В CI/CD пайплайне реализован механизм автоматического отката при ошибках:
- Проверка работоспособности после деплоя
- Откат к предыдущей версии при критических ошибках

### Ручной откат

Для ручного отката можно использовать бэкапы:
1. Остановить текущую систему
2. Восстановить из бэкапа
3. Запустить систему

## Мониторинг развертывания

### Проверка состояния сервисов

После развертывания автоматически проверяется состояние сервисов:
- Доступность фронтенда
- Доступность бэкенда
- Доступность базы данных
- Доступность сервисов мониторинга

### Логи развертывания

Логи развертывания сохраняются в системные логи и могут быть просмотрены:
```bash
docker compose logs
```

## Обновление конфигурации

### Переменные окружения

Конфигурация системы определяется в файле `.env`. Для обновления конфигурации:
1. Обновите файл `.env`
2. Перезапустите сервисы:
   ```bash
   docker compose down
   docker compose up -d
   ```

### Конфигурация Traefik

Конфигурация Traefik находится в директории `/opt/application/traefik/`:
- `traefik.yml` - Основная конфигурация
- `dynamic/` - Динамическая конфигурация

### Конфигурация мониторинга

Конфигурация мониторинга находится в директории `/opt/application/monitoring/`:
- `prometheus.yml` - Конфигурация Prometheus
- `admin-panel-rules.yml` - Правила оповещения
- `loki.yml` - Конфигурация Loki
- `promtail.yml` - Конфигурация Promtail

## Безопасность развертывания

### Ключи и секреты

Секреты не хранятся в репозитории:
- Используются GitHub Secrets для CI/CD
- Переменные окружения для локального запуска

### Права доступа

Скрипты развертывания должны запускаться с соответствующими правами:
- Доступ к Docker
- Доступ к директории приложения
- Права для настройки cron

## Устранение неполадок

### Деплой завершается с ошибкой

1. Проверьте логи скрипта развертывания
2. Убедитесь, что все зависимости установлены
3. Проверьте доступ к Docker
4. Проверьте права доступа к файлам

### Сервисы не запускаются

1. Проверьте логи контейнеров:
   ```bash
   docker compose logs service_name
   ```
2. Убедитесь, что порты не заняты
3. Проверьте конфигурацию сервисов

### Проблемы с базой данных

1. Проверьте логи PostgreSQL:
   ```bash
   docker compose logs postgres
   ```
2. Убедитесь, что переменные окружения для БД корректны
3. Проверьте сетевое взаимодействие между сервисами

### Проблемы с мониторингом

См. документацию по мониторингу для устранения неполадок.