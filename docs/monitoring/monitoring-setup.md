# Мониторинг админ-панели CRM системы

## Обзор

Эта документация описывает систему мониторинга админ-панели CRM системы, включая настройку, компоненты и использование.

## Компоненты мониторинга

Система мониторинга состоит из следующих компонентов:

1. **Prometheus** - Система сбора метрик
2. **Grafana** - Система визуализации метрик
3. **Loki** - Система сбора и агрегации логов
4. **Promtail** - Агент для сбора логов

## Архитектура

```
+------------------+     +------------------+     +------------------+
|   Application    |     |   Prometheus     |     |     Grafana      |
|     (Spring      |---->|   (Metrics       |---->|   (Dashboard     |
|      Boot)       |     |    Collection)   |     |   Visualization) |
+------------------+     +------------------+     +------------------+
         |                        |                        |
         |                        |                        |
         |                 +-----v-----+            +-----v-----+
         |                 |  Metrics  |            | Dashboards|
         |                 |   Data    |            |    &      |
         |                 +-----------+            |  Alerts   |
         |                                          +-----------+
+--------v---------+                                          |
|      Loki        |<-----------------------------------------+
|  (Log Storage)   |
+------------------+
         ^
         |
+--------v---------+
|    Promtail      |
|  (Log Collector) |
+------------------+
```

## Установка и настройка

### Docker Compose

Конфигурация мониторинга определена в файле `docker-compose.yml`. Система автоматически развертывается вместе с основным приложением.

### Конфигурационные файлы

#### Prometheus (`/opt/application/monitoring/prometheus.yml`)

Основной файл конфигурации Prometheus, определяющий:
- Цели сбора метрик
- Интервалы сбора
- Правила оповещения

#### Правила оповещения (`/opt/application/monitoring/admin-panel-rules.yml`)

Файл содержит правила оповещения для различных метрик:
- Доступность сервисов
- Время отклика
- Использование памяти и CPU
- Количество подключений к БД

#### Grafana Dashboard (`/opt/application/monitoring/admin-panel-dashboard.json`)

Предопределенный дашборд для визуализации метрик админ-панели:
- Время отклика API
- Использование памяти
- Использование CPU
- Количество подключений к БД
- Общее количество запросов
- Процент ошибок

#### Loki (`/opt/application/monitoring/loki.yml`)

Конфигурация системы сбора и хранения логов.

#### Promtail (`/opt/application/monitoring/promtail.yml`)

Конфигурация агента сбора логов, определяющая:
- Источники логов
- Парсеры логов
- Целевые системы хранения

## Метрики

### Бэкенд (Spring Boot)

- Время отклика HTTP запросов
- Использование памяти (heap/non-heap)
- Использование CPU
- Количество потоков
- Размер пула соединений к БД
- Количество активных HTTP сессий

### Фронтенд

- Время загрузки страниц
- Количество ошибок JavaScript
- Время выполнения API запросов

### База данных (PostgreSQL)

- Количество активных соединений
- Время выполнения запросов
- Размер базы данных
- Количество блокировок

### Traefik

- Количество запросов
- Время отклика
- Коды ответов
- Количество ошибок

## Логирование

### Централизованное логирование

Все логи собираются и хранятся централизованно с помощью Loki. Это позволяет:

- Искать логи по времени, уровню, содержимому
- Анализировать ошибки и исключения
- Отслеживать действия администраторов
- Анализировать медленные запросы

### Источники логов

1. **Бэкенд приложение** - `/var/log/admin-panel/backend.log`
2. **Фронтенд приложение** - `/var/log/admin-panel/frontend.log`
3. **База данных** - `/var/log/postgresql/*.log`
4. **Traefik** - `/var/log/traefik/*.log`

## Алертинг

Система оповещения настроена для уведомления о критических ситуациях:

### Критические алерты

- Сервисы недоступны
- Высокий процент ошибок
- Превышение порогов использования ресурсов

### Предупреждения

- Высокое время отклика
- Высокое использование памяти/CPU
- Большое количество подключений к БД

## Дашборды Grafana

### Основной дашборд админ-панели

Включает панели:
- Время отклика API (50th, 95th, 99th перцентили)
- Использование памяти
- Использование CPU
- Количество подключений к БД
- Общее количество запросов
- Процент ошибок
- Время загрузки страниц фронтенда

## Доступ к системам мониторинга

- **Grafana**: https://grafana.crm-synergy.ru (admin/admin)
- **Prometheus**: https://prometheus.crm-synergy.ru
- **Loki**: https://loki.crm-synergy.ru

## Резервное копирование данных мониторинга

Метрики Prometheus хранятся в течение 200 часов. Для долгосрочного хранения необходимо настроить дополнительное резервное копирование.

## Устранение неполадок

### Сервисы мониторинга не запускаются

1. Проверьте логи контейнеров:
   ```bash
   docker compose logs prometheus
   docker compose logs grafana
   docker compose logs loki
   docker compose logs promtail
   ```

2. Убедитесь, что все необходимые директории созданы:
   ```bash
   ls -la /opt/application/monitoring/
   ```

### Нет данных в Grafana

1. Проверьте, что Prometheus собирает метрики:
   - Откройте Prometheus UI
   - Проверьте статус целей (Targets)

2. Проверьте конфигурацию источников данных Grafana:
   - Откройте Grafana
   - Перейдите в Configuration → Data Sources
   - Проверьте подключение к Prometheus и Loki

### Нет логов в Loki

1. Проверьте, что Promtail запущен и работает:
   ```bash
   docker compose logs promtail
   ```

2. Проверьте конфигурацию Promtail:
   - Убедитесь, что пути к логам указаны правильно
   - Проверьте, что у Promtail есть доступ к логам