# Точки интеграции для Telegram-бота и уведомлений по электронной почте

## Интеграция Telegram-бота

### Архитектура
- **Отдельный сервис**: Приложение Node.js с использованием фреймворка Telegraf.js
- **Коммуникация**: Вызовы REST API между основным приложением и ботом
- **Хранение данных**: Совместный доступ к базе данных для информации о пользователях и уведомлениях

### Основная функциональность
1. **Регистрация пользователей**
   - Студенты и преподаватели получают электронное письмо со ссылкой на бота
   - Пользователи начинают диалог с ботом
   - Бот захватывает chat_id и связывает с учетной записью пользователя
   - Вызов API основного приложения для обновления записи пользователя с chat_id

2. **Типы уведомлений**
   - Урок запланирован/обновлен
   - Урок отменен
   - Напоминания о предстоящих уроках (за 24 часа, за 1 час)
   - Пакет скоро заканчивается (≤ 3 урока)
   - Запросы на подтверждение урока

3. **Интерактивные функции**
   - Отмена урока студентами (с проверкой времени)
   - Подтверждение урока преподавателями
   - Просмотр предстоящих уроков
   - Помощь и поддержка

### Точки интеграции API
- **Конечная точка вебхука**: POST /api/notifications/telegram/send
  - Запрос: { userId, messageType, payload }
  - Ответ: { success: true/false, error_message }

- **Конечная точка регистрации пользователя**: POST /api/users/{userId}/telegram
  - Запрос: { chatId }
  - Ответ: { success: true/false }

- **Конечная точка отмены урока**: POST /api/lessons/{lessonId}/cancel
  - Запрос: { cancelledBy: "STUDENT", chatId }
  - Ответ: { success: true/false, status, message }

- **Конечная точка подтверждения урока**: POST /api/lessons/{lessonId}/confirm
  - Запрос: { confirmed: true/false, chatId }
  - Ответ: { success: true/false, status, message }

### Команды бота
- `/start` - Начальная регистрация и помощь
- `/lessons` - Просмотр предстоящих уроков
- `/cancel` - Отмена предстоящего урока (с выбором)
- `/help` - Показать справочную информацию
- `/feedback` - Оставить отзыв (будущая функция)

### Шаблоны сообщений
- **Урок запланирован**: "У вас новый урок с {teacher_name} {date} в {time}. Присоединяйтесь по ссылке: {video_link}"
- **Урок отменен**: "Ваш урок с {teacher_name} {date} в {time} отменен. Причина: {reason}"
- **Напоминание**: "Напоминание: У вас урок с {teacher_name} сегодня в {time}. Присоединяйтесь по ссылке: {video_link}"
- **Пакет заканчивается**: "Ваш пакет уроков скоро закончится. У вас осталось {count} уроков."
- **Запрос подтверждения**: "Пожалуйста, подтвердите, что урок с {student_name} {date} в {time} завершен."

## Система уведомлений по электронной почте

### Архитектура
- **Интегрированный сервис**: Модуль Spring Mail в основном приложении
- **Шаблонизатор**: Thymeleaf для шаблонов электронной почты
- **Конфигурация SMTP**: Настраиваемые параметры SMTP

### Основная функциональность
1. **Электронные письма при создании учетной записи**
   - Приветственное письмо с учетными данными для входа
   - Инструкции по доступу к приложению
   - Инструкции по подключению Telegram-бота (для преподавателей/студентов)

2. **Типы уведомлений**
   - Создание учетной записи пользователя
   - Запросы на сброс пароля
   - Уведомления о техническом обслуживании системы (только для администратора)

### Шаблоны электронных писем
- **Приветствие менеджера**: Приветственное письмо с временным паролем и инструкциями по входу
- **Приветствие преподавателя**: Приветственное письмо с временным паролем, инструкциями по входу и настройкой Telegram-бота
- **Инструкции для студента**: Электронное письмо с инструкциями по Telegram-боту

### Точки интеграции API
- **Служба отправки электронной почты**: Внутренняя служба в основном приложении
- **Управление шаблонами**: Шаблоны Thymeleaf, хранящиеся в ресурсах
- **Конфигурация**: Параметры SMTP для конкретной среды

### Повторная отправка вручную
- **Интерфейс менеджера**: Кнопка на страницах деталей пользователя для повторной отправки приветственного письма
- **Интерфейс администратора**: Возможности массовой повторной отправки электронных писем

### Меры безопасности для уведомлений
1. **Telegram**:
   - Проверка всех входящих запросов от Telegram
   - Безопасная конечная точка вебхука с секретным токеном
   - Ограничение команд бота только для авторизованных пользователей

2. **Электронная почта**:
   - Защита учетных данных SMTP
   - Ограничение частоты отправки электронных писем
   - Проверка адресов электронной почты перед отправкой

### Мониторинг и логирование
- **Telegram**: Логирование всех отправленных сообщений и взаимодействий пользователей
- **Электронная почта**: Логирование всех отправленных писем со статусом
- **Обработка ошибок**: Механизм повтора для неудачных уведомлений
- **Метрики**: Отслеживание коэффициентов успешной доставки