name: Deploy to Production

on:
  workflow_run:
    workflows: ["CRM System CI/CD"]
    types: [completed]
    branches: [master]

env:
  SERVER_HOST: ${{ secrets.PRODUCTION_HOST }}
  SERVER_USER: ${{ secrets.PRODUCTION_USER }}
  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
  APP_DIR: "/opt/crm-synergy"

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: deployment-artifacts
        path: artifacts

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Add server to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.PRODUCTION_HOST }} >> ~/.ssh/known_hosts

    - name: Copy artifacts to server
      run: |
        scp -r artifacts/* ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }}:${{ env.APP_DIR }}/

    - name: Copy deployment scripts to server
      run: |
        scp -r scripts/ ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }}:${{ env.APP_DIR }}/

    - name: Run deployment script on server
      run: |
        ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} "
          cd ${{ env.APP_DIR }}
          sudo bash scripts/deploy-production.sh
        "

    - name: Verify deployment
      run: |
        ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} "
          systemctl status crm-synergy-backend --no-pager -l | head -5
          curl -f https://${{ secrets.PRODUCTION_HOST }}/api/health || exit 1
        "

    - name: Cleanup old deployments
      run: |
        ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} "
          cd ${{ env.APP_DIR }}
          sudo bash scripts/cleanup-old-deployments.sh
        "
