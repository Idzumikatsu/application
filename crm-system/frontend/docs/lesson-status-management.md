# Система управления статусами уроков

## Обзор

Система управления статусами уроков предоставляет комплексное решение для отслеживания и управления статусами уроков в CRM системе. Она включает в себя автоматические переходы статусов, историю изменений, уведомления и статистику.

## Компоненты системы

### 1. Типы данных

#### LessonStatus
```typescript
enum LessonStatus {
  SCHEDULED = 'SCHEDULED',    // Запланирован
  CONDUCTED = 'CONDUCTED',    // Проведен
  COMPLETED = 'COMPLETED',    // Завершен
  CANCELLED = 'CANCELLED',    // Отменен
  MISSED = 'MISSED'           // Пропущен
}
```

#### LessonStatusHistory
```typescript
interface LessonStatusHistory {
  id: number;
  lessonId: number;
  oldStatus: LessonStatus;
  newStatus: LessonStatus;
  changedAt: string;
  changedBy: string;
  changeReason?: string;
  automated: boolean;
}
```

### 2. Сервисы

#### LessonService
Основной сервис для работы с уроками, включая изменение статусов.

#### LessonStatusTransitionService
Сервис автоматических переходов статусов с правилами:
- SCHEDULED → CONDUCTED (начало урока)
- CONDUCTED → COMPLETED (завершение урока)
- SCHEDULED → CANCELLED (автоматическая отмена)
- SCHEDULED → MISSED (пропуск урока)

#### NotificationService
Сервис уведомлений о смене статусов уроков.

### 3. Компоненты React

#### LessonStatusDisplay
Отображает текущий статус урока с цветовой индикацией.

#### LessonStatusChanger
Позволяет вручную изменять статус урока с указанием причины.

#### LessonStatusHistory
Отображает историю изменений статусов урока.

#### LessonStatusStatistics
Показывает статистику по статусам уроков.

#### LessonStatusAutomation
Компонент для управления автоматическими переходами статусов.

#### NotificationPanel
Панель уведомлений о смене статусов.

## Автоматические переходы статусов

### Правила переходов

1. **Начало урока** (SCHEDULED → CONDUCTED)
   - Время: в запланированное время начала урока
   - Условие: текущее время >= времени начала урока

2. **Завершение урока** (CONDUCTED → COMPLETED)
   - Время: по истечении длительности урока
   - Условие: текущее время >= времени окончания урока

3. **Автоматическая отмена** (SCHEDULED → CANCELLED)
   - Время: за 1 час до начала урока
   - Условие: учитель не подтвердил урок

4. **Пропуск урока** (SCHEDULED → MISSED)
   - Время: через 15 минут после начала урока
   - Условие: урок не начался вовремя

### Периодическая проверка

Система автоматически проверяет статусы уроков каждые 5 минут и применяет соответствующие переходы.

## Уведомления

### Типы уведомлений

- `LESSON_COMPLETED` - Урок завершен
- `LESSON_CANCELLED` - Урок отменен
- `LESSON_SCHEDULED` - Урок запланирован

### Каналы уведомлений

- Email
- Telegram
- Push-уведомления

## Интеграция

### С существующими страницами

Компоненты интегрированы в:
- Страницу расписания учителя
- Страницу управления уроками менеджера
- Дашборд студента

### API endpoints

```
GET    /api/lessons/{id}/status-history
POST   /api/lessons/{id}/change-status
GET    /api/lessons/statistics/status
POST   /api/notifications/lesson-status
```

## Безопасность

- Только авторизованные пользователи могут изменять статусы
- Учителя могут изменять статусы только своих уроков
- Менеджеры могут изменять статусы всех уроков
- Автоматические переходы выполняются системой

## Мониторинг и логирование

- Все изменения статусов логируются
- Автоматические переходы записываются с пометкой "automated: true"
- Ошибки при автоматических переходах логируются в консоль

## Настройки

Пользователи могут настраивать:
- Получение уведомлений о смене статусов
- Каналы получения уведомлений
- Типы уведомлений для получения

## Тестирование

Система включает:
- Unit tests для сервисов
- Integration tests для компонентов
- E2E tests для автоматических переходов

## Развертывание

1. Убедитесь, что все зависимости установлены
2. Соберите проект: `npm run build`
3. Запустите сервер: `npm start`
4. Автоматические переходы активируются автоматически

## Поддержка

Для вопросов и проблем обращайтесь:
- Техническая поддержка: support@crm-system.com
- Документация: docs.crm-system.com
- GitHub Issues: github.com/crm-system/issues